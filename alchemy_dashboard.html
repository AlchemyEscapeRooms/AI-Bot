<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Alchemy Effect</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           THE ALCHEMY EFFECT - Slate & Sage Theme
           ============================================ */

        :root {
            /* Slate & Sage Palette */
            --bg-dark: #1a1d23;
            --bg-card: #242830;
            --bg-card-hover: #2a2f38;
            --border: #353b45;
            --border-light: #454c58;

            /* Text */
            --text-primary: #e8ecf2;
            --text-secondary: #9aa3b0;
            --text-muted: #6b7280;

            /* Matte Colors */
            --sage-green: #6b8f71;
            --sage-green-bg: rgba(107, 143, 113, 0.15);
            --dusty-rose: #a65d5d;
            --dusty-rose-bg: rgba(166, 93, 93, 0.15);
            --steel-blue: #8fa8bf;
            --steel-blue-bg: rgba(143, 168, 191, 0.15);
            --amber: #c9a962;
            --amber-bg: rgba(201, 169, 98, 0.15);

            /* Status */
            --active: #6b8f71;
            --inactive: #6b7280;
            --warning: #c9a962;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* ============================================
           HEADER
           ============================================ */

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 28px;
        }

        .logo-text {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            color: var(--amber);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .bot-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .bot-status.active {
            background: var(--sage-green-bg);
            border: 1px solid var(--sage-green);
            color: var(--sage-green);
        }

        .bot-status.inactive {
            background: var(--dusty-rose-bg);
            border: 1px solid var(--dusty-rose);
            color: var(--dusty-rose);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .bot-controls {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-light);
        }

        .btn-primary {
            background: var(--sage-green);
            border-color: var(--sage-green);
            color: white;
        }

        .btn-primary:hover {
            background: #5a7e60;
        }

        .btn-danger {
            background: var(--dusty-rose);
            border-color: var(--dusty-rose);
            color: white;
        }

        /* ============================================
           NAVIGATION TABS
           ============================================ */

        .nav-tabs {
            display: flex;
            gap: 0;
            padding: 0 32px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .nav-tab {
            padding: 14px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            text-decoration: none;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-tab:hover {
            color: var(--text-primary);
        }

        .nav-tab.active {
            color: var(--amber);
            border-bottom-color: var(--amber);
        }

        /* ============================================
           MAIN CONTENT
           ============================================ */

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px 32px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ============================================
           CARDS
           ============================================ */

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-link {
            font-size: 13px;
            color: var(--steel-blue);
            text-decoration: none;
            cursor: pointer;
        }

        .card-link:hover {
            text-decoration: underline;
        }

        /* ============================================
           BRAIN STATUS CARD (Top)
           ============================================ */

        .brain-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, #282d36 100%);
        }

        .brain-stats {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .brain-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--sage-green-bg);
            border-radius: 20px;
            font-size: 13px;
            color: var(--sage-green);
        }

        .brain-stat {
            text-align: center;
        }

        .brain-stat-value {
            font-size: 24px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .brain-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .brain-latest {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* ============================================
           LIVE ACTIVITY FEED
           ============================================ */

        .activity-feed {
            background: linear-gradient(135deg, #1e2228 0%, #242830 100%);
            border: 1px solid var(--border);
            border-left: 3px solid var(--amber);
            max-height: 280px;
            overflow: hidden;
            position: relative;
        }

        .activity-feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border);
        }

        .activity-feed-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--amber);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .activity-feed-title .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--sage-green);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .activity-feed-content {
            padding: 0;
            max-height: 220px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .activity-feed-content::-webkit-scrollbar {
            width: 4px;
        }

        .activity-feed-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .activity-feed-content::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 2px;
        }

        .activity-item {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            animation: slideIn 0.3s ease-out;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .activity-icon.prediction {
            background: var(--steel-blue-bg);
            color: var(--steel-blue);
        }

        .activity-icon.confirmed {
            background: var(--sage-green-bg);
            color: var(--sage-green);
        }

        .activity-icon.trade {
            background: var(--amber-bg);
            color: var(--amber);
        }

        .activity-icon.analysis {
            background: rgba(156, 136, 255, 0.15);
            color: #9c88ff;
        }

        .activity-icon.alert {
            background: var(--dusty-rose-bg);
            color: var(--dusty-rose);
        }

        .activity-icon.learning {
            background: rgba(0, 210, 211, 0.15);
            color: #00d2d3;
        }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-message {
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .activity-message .highlight {
            color: var(--amber);
            font-weight: 600;
        }

        .activity-message .symbol {
            color: var(--steel-blue);
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .activity-message .price {
            color: var(--text-primary);
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .activity-message .profit {
            color: var(--sage-green);
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .activity-message .loss {
            color: var(--dusty-rose);
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .activity-message .confidence {
            color: var(--amber);
            font-weight: 500;
        }

        .activity-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .activity-time {
            font-family: 'JetBrains Mono', monospace;
        }

        .activity-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .activity-badge.correct {
            background: var(--sage-green-bg);
            color: var(--sage-green);
        }

        .activity-badge.pending {
            background: var(--amber-bg);
            color: var(--amber);
        }

        .activity-badge.wrong {
            background: var(--dusty-rose-bg);
            color: var(--dusty-rose);
        }

        .activity-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .activity-empty-icon {
            font-size: 32px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        /* ============================================
           P&L HERO CARD (Center)
           ============================================ */

        .pnl-card {
            text-align: center;
            padding: 40px 20px;
        }

        .pnl-value {
            font-size: 56px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -2px;
        }

        .pnl-value.positive { color: var(--sage-green); }
        .pnl-value.negative { color: var(--dusty-rose); }

        .pnl-percent {
            font-size: 18px;
            font-weight: 500;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .pnl-percent.positive { color: var(--sage-green); }
        .pnl-percent.negative { color: var(--dusty-rose); }

        .sparkline-container {
            margin: 24px auto;
            max-width: 400px;
            height: 60px;
        }

        .sparkline {
            display: flex;
            align-items: flex-end;
            height: 100%;
            gap: 2px;
        }

        .sparkline-bar {
            flex: 1;
            background: var(--steel-blue);
            border-radius: 2px 2px 0 0;
            min-height: 4px;
            transition: all 0.3s;
        }

        .sparkline-bar:hover {
            background: var(--amber);
        }

        .pnl-journey {
            font-size: 14px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .pnl-journey span {
            color: var(--text-secondary);
        }

        /* ============================================
           BOTTOM ROW CARDS
           ============================================ */

        .bottom-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        /* Trending Card */
        .trending-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .trending-item:last-child {
            border-bottom: none;
        }

        .trending-symbol {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .trending-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .trending-change {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .trending-change.up { color: var(--sage-green); }

        .trending-confidence {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Yesterday Card */
        .yesterday-stat {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .yesterday-stat:last-child {
            border-bottom: none;
        }

        .yesterday-label {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .yesterday-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        .yesterday-value.positive { color: var(--sage-green); }
        .yesterday-value.negative { color: var(--dusty-rose); }

        /* Predicted Profit Card */
        .predicted-range {
            text-align: center;
            padding: 20px 0;
        }

        .predicted-value {
            font-size: 28px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            color: var(--amber);
        }

        .predicted-meta {
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .predicted-confidence {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
        }

        .confidence-bar {
            width: 100px;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: var(--amber);
            border-radius: 3px;
        }

        /* ============================================
           BRAIN TAB (Full Page)
           ============================================ */

        .brain-section {
            margin-bottom: 32px;
        }

        .brain-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .weight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .weight-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
        }

        .weight-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .weight-name {
            font-weight: 600;
            font-size: 15px;
        }

        .weight-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .weight-badge.strong {
            background: var(--sage-green-bg);
            color: var(--sage-green);
        }

        .weight-badge.weak {
            background: var(--dusty-rose-bg);
            color: var(--dusty-rose);
        }

        .weight-badge.normal {
            background: var(--steel-blue-bg);
            color: var(--steel-blue);
        }

        .weight-description {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .weight-bar-container {
            margin-bottom: 8px;
        }

        .weight-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .weight-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .weight-bar-fill.strong { background: var(--sage-green); }
        .weight-bar-fill.weak { background: var(--dusty-rose); }
        .weight-bar-fill.normal { background: var(--steel-blue); }

        .weight-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Stock Profiles */
        .stock-profile {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stock-symbol {
            font-size: 18px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .stock-predictions {
            font-size: 12px;
            color: var(--text-muted);
        }

        .stock-signals {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .stock-signal {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-dark);
            border-radius: 6px;
            font-size: 12px;
        }

        .signal-indicator {
            font-size: 10px;
        }

        .signal-indicator.up { color: var(--sage-green); }
        .signal-indicator.down { color: var(--dusty-rose); }
        .signal-indicator.neutral { color: var(--text-muted); }

        /* ============================================
           TRADES TAB
           ============================================ */

        .trades-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trades-table th {
            text-align: left;
            padding: 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .trades-table td {
            padding: 14px 12px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        .trades-table tr:hover {
            background: var(--bg-card-hover);
        }

        .trade-symbol {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .trade-action {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .trade-action.buy {
            background: var(--sage-green-bg);
            color: var(--sage-green);
        }

        .trade-action.sell {
            background: var(--dusty-rose-bg);
            color: var(--dusty-rose);
        }

        .trade-pnl {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        .trade-pnl.positive { color: var(--sage-green); }
        .trade-pnl.negative { color: var(--dusty-rose); }

        /* ============================================
           LOADING & EMPTY STATES
           ============================================ */

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--amber);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* ============================================
           RESPONSIVE
           ============================================ */

        @media (max-width: 1024px) {
            .bottom-row {
                grid-template-columns: 1fr;
            }

            .brain-stats {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
            }

            .container {
                padding: 16px;
            }

            .pnl-value {
                font-size: 40px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <span class="logo-icon">‚öóÔ∏è</span>
            <span class="logo-text">The <span>Alchemy</span> Effect</span>
        </div>
        <div class="header-right">
            <div class="bot-status active" id="bot-status">
                <span class="status-dot"></span>
                <span id="bot-status-text">Bot Active</span>
            </div>
            <div class="bot-controls">
                <button class="btn btn-primary" onclick="controlBot('start')">Start</button>
                <button class="btn btn-danger" onclick="controlBot('stop')">Stop</button>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="nav-tabs">
        <a class="nav-tab active" data-tab="dashboard">Dashboard</a>
        <a class="nav-tab" data-tab="trades">Trades</a>
        <a class="nav-tab" data-tab="brain">Brain</a>
        <a class="nav-tab" data-tab="reports">Reports</a>
        <a class="nav-tab" data-tab="backtest">Backtest</a>
        <a class="nav-tab" data-tab="settings">Settings</a>
    </nav>

    <!-- Main Content -->
    <main class="container">

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="tab-dashboard">

            <!-- Brain Status Card (Top) -->
            <div class="card brain-card">
                <div class="card-header">
                    <span class="card-title">üß† AI Brain Status</span>
                    <a class="card-link" onclick="switchTab('brain')">View Details ‚Üí</a>
                </div>
                <div class="brain-stats">
                    <div class="brain-status-indicator">
                        <span class="status-dot"></span>
                        Learning Active
                    </div>
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="brain-accuracy">--</div>
                        <div class="brain-stat-label">Accuracy</div>
                    </div>
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="brain-predictions">--</div>
                        <div class="brain-stat-label">Predictions</div>
                    </div>
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="brain-correct">--</div>
                        <div class="brain-stat-label">Correct</div>
                    </div>
                </div>
                <div class="brain-latest" id="brain-latest">
                    Loading latest activity...
                </div>
            </div>

            <!-- Live Activity Feed -->
            <div class="card activity-feed" id="activity-feed">
                <div class="activity-feed-header">
                    <div class="activity-feed-title">
                        <span class="pulse-dot"></span>
                        Live Activity
                    </div>
                    <span style="font-size: 11px; color: var(--text-muted);">Auto-refreshing</span>
                </div>
                <div class="activity-feed-content" id="activity-feed-content">
                    <div class="activity-empty">
                        <div class="activity-empty-icon">üì°</div>
                        <div>Waiting for bot activity...</div>
                        <div style="margin-top: 4px; font-size: 11px;">Start the bot to see live updates</div>
                    </div>
                </div>
            </div>

            <!-- P&L Hero Card (Center) -->
            <div class="card pnl-card">
                <div class="pnl-value positive" id="pnl-value">$0.00</div>
                <div class="pnl-percent positive" id="pnl-percent">
                    <span>‚ñ≤</span>
                    <span>0.00% today</span>
                </div>
                <div class="sparkline-container">
                    <div class="sparkline" id="sparkline"></div>
                </div>
                <div class="pnl-journey">
                    <span id="initial-capital">$100,000</span> ‚Üí <span id="current-value">$100,000</span>
                </div>
            </div>

            <!-- Bottom Row -->
            <div class="bottom-row">

                <!-- Trending Up Card -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üìà Trending Up</span>
                    </div>
                    <div id="trending-list">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Loading...
                        </div>
                    </div>
                </div>

                <!-- Yesterday Summary Card -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üìã Yesterday</span>
                    </div>
                    <div id="yesterday-summary">
                        <div class="yesterday-stat">
                            <span class="yesterday-label">P&L</span>
                            <span class="yesterday-value" id="yesterday-pnl">--</span>
                        </div>
                        <div class="yesterday-stat">
                            <span class="yesterday-label">Trades</span>
                            <span class="yesterday-value" id="yesterday-trades">--</span>
                        </div>
                        <div class="yesterday-stat">
                            <span class="yesterday-label">Win Rate</span>
                            <span class="yesterday-value" id="yesterday-winrate">--</span>
                        </div>
                        <div class="yesterday-stat">
                            <span class="yesterday-label">Best Trade</span>
                            <span class="yesterday-value positive" id="yesterday-best">--</span>
                        </div>
                    </div>
                </div>

                <!-- Predicted Profit Card -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üéØ Predicted Profit</span>
                    </div>
                    <div class="predicted-range">
                        <div class="predicted-value" id="predicted-range">$0 ‚Äì $0</div>
                        <div class="predicted-meta">
                            <span id="predicted-signals">0</span> open signals
                        </div>
                        <div class="predicted-confidence">
                            <span id="predicted-conf-text">0%</span> avg confidence
                            <div class="confidence-bar">
                                <div class="confidence-fill" id="predicted-conf-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trades Tab -->
        <div class="tab-content" id="tab-trades">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Recent Trades</span>
                </div>
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Symbol</th>
                            <th>Action</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>P&L</th>
                            <th>Strategy</th>
                        </tr>
                    </thead>
                    <tbody id="trades-body">
                        <tr>
                            <td colspan="7" class="loading">
                                <div class="loading-spinner"></div>
                                Loading trades...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Brain Tab -->
        <div class="tab-content" id="tab-brain">

            <!-- Brain Summary -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üß† Learning Summary</span>
                </div>
                <div class="brain-stats" style="justify-content: flex-start;">
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="brain-detail-accuracy">--</div>
                        <div class="brain-stat-label">Overall Accuracy</div>
                    </div>
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="brain-detail-total">--</div>
                        <div class="brain-stat-label">Total Predictions</div>
                    </div>
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="brain-detail-correct">--</div>
                        <div class="brain-stat-label">Correct</div>
                    </div>
                    <div class="brain-stat">
                        <div class="brain-stat-value" id="brain-detail-wrong">--</div>
                        <div class="brain-stat-label">Wrong</div>
                    </div>
                </div>
            </div>

            <!-- How It Works -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üí° How The Brain Learns</span>
                </div>
                <p style="color: var(--text-secondary); line-height: 1.7;">
                    The bot tracks which signals lead to correct predictions. Signals that perform well get <strong style="color: var(--sage-green);">MORE weight</strong> (trusted more).
                    Signals that perform poorly get <strong style="color: var(--dusty-rose);">LESS weight</strong>.
                    Weights range from 0.5 to 2.0, starting at 1.0. Each stock also develops its own preferences over time.
                </p>
            </div>

            <!-- Global Signal Weights -->
            <div class="brain-section">
                <div class="brain-section-title">üìä Global Signal Weights</div>
                <div class="weight-grid" id="global-weights">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading...
                    </div>
                </div>
            </div>

            <!-- Per-Stock Weights -->
            <div class="brain-section">
                <div class="brain-section-title">üè∑Ô∏è Per-Stock Learning</div>
                <div id="stock-profiles">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading...
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-content" id="tab-reports">
            <!-- Performance Summary -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìä Performance Summary</span>
                    <div style="display: flex; gap: 10px;">
                        <select id="report-period" onchange="loadReports()" style="padding: 6px 12px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
                            <option value="7">Last 7 Days</option>
                            <option value="30" selected>Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                            <option value="365">Last Year</option>
                        </select>
                        <button onclick="exportReport('csv')" class="btn" style="font-size: 13px;">Export CSV</button>
                        <button onclick="exportReport('pdf')" class="btn" style="font-size: 13px;">Export PDF</button>
                    </div>
                </div>
                <div style="padding: 20px;">
                    <div class="brain-stats" style="justify-content: flex-start; flex-wrap: wrap; gap: 40px;">
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-total-pnl">$0.00</div>
                            <div class="brain-stat-label">Total P&L</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-total-trades">0</div>
                            <div class="brain-stat-label">Total Trades</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-win-rate">0%</div>
                            <div class="brain-stat-label">Win Rate</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-profit-factor">0.00</div>
                            <div class="brain-stat-label">Profit Factor</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-avg-win">$0.00</div>
                            <div class="brain-stat-label">Avg Win</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-avg-loss">$0.00</div>
                            <div class="brain-stat-label">Avg Loss</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-max-drawdown">0%</div>
                            <div class="brain-stat-label">Max Drawdown</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="report-sharpe">0.00</div>
                            <div class="brain-stat-label">Sharpe Ratio</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daily P&L Chart -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìà Daily P&L</span>
                </div>
                <div style="padding: 20px;">
                    <div id="daily-pnl-chart" style="height: 200px; display: flex; align-items: flex-end; gap: 2px; padding: 10px 0;">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Loading chart...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Performers -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                <!-- Best Performing Symbols -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üèÜ Top Performers</span>
                    </div>
                    <div id="top-performers">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Loading...
                        </div>
                    </div>
                </div>

                <!-- Worst Performing Symbols -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üìâ Worst Performers</span>
                    </div>
                    <div id="worst-performers">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            Loading...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Strategy Performance -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üéØ Strategy Performance</span>
                </div>
                <div style="padding: 20px;">
                    <table class="trades-table">
                        <thead>
                            <tr>
                                <th>Strategy</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>P&L</th>
                                <th>Avg Trade</th>
                            </tr>
                        </thead>
                        <tbody id="strategy-performance-body">
                            <tr>
                                <td colspan="5" class="loading">
                                    <div class="loading-spinner"></div>
                                    Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Trade Log -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìã Trade Log</span>
                    <a class="card-link" onclick="switchTab('trades')">View All Trades ‚Üí</a>
                </div>
                <div style="padding: 20px;">
                    <table class="trades-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Symbol</th>
                                <th>Action</th>
                                <th>Qty</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>P&L</th>
                                <th>Strategy</th>
                            </tr>
                        </thead>
                        <tbody id="report-trades-body">
                            <tr>
                                <td colspan="8" class="empty-state">No trades in selected period</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Backtest Tab -->
        <div class="tab-content" id="tab-backtest">
            <!-- Backtest Configuration -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üß™ Run Backtest</span>
                </div>
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">Symbol</label>
                            <input type="text" id="backtest-symbol" placeholder="AAPL"
                                   style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">Start Date</label>
                            <input type="date" id="backtest-start"
                                   style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">End Date</label>
                            <input type="date" id="backtest-end"
                                   style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">Strategy</label>
                            <select id="backtest-strategy"
                                    style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                                <option value="ai_adaptive">AI Adaptive (All Signals)</option>
                                <option value="momentum">Momentum</option>
                                <option value="mean_reversion">Mean Reversion</option>
                                <option value="trend_following">Trend Following</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">Mode</label>
                            <select id="backtest-mode"
                                    style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                                <option value="test">Test Only (Temp DB)</option>
                                <option value="learn">Learn & Save to Main DB</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="runBacktest()" id="backtest-run-btn"
                            style="padding: 14px 32px; background: var(--sage-green); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span>‚ñ∂</span> Run Backtest
                    </button>
                </div>
            </div>

            <!-- Backtest Progress -->
            <div class="card" id="backtest-progress-card" style="display: none;">
                <div class="card-header">
                    <span class="card-title">‚è≥ Running Backtest...</span>
                </div>
                <div style="padding: 20px;">
                    <div style="background: var(--bg-primary); border-radius: 8px; height: 20px; overflow: hidden;">
                        <div id="backtest-progress-bar" style="background: var(--sage-green); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p id="backtest-progress-text" style="color: var(--text-secondary); margin-top: 10px; text-align: center;">Initializing...</p>
                </div>
            </div>

            <!-- Backtest Results -->
            <div class="card" id="backtest-results-card" style="display: none;">
                <div class="card-header">
                    <span class="card-title">üìä Backtest Results</span>
                </div>
                <div style="padding: 20px;">
                    <div class="brain-stats" style="justify-content: flex-start; flex-wrap: wrap; gap: 30px;">
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="backtest-result-symbol">--</div>
                            <div class="brain-stat-label">Symbol</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="backtest-result-predictions">--</div>
                            <div class="brain-stat-label">Total Predictions</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value positive" id="backtest-result-accuracy">--</div>
                            <div class="brain-stat-label">Overall Accuracy</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="backtest-result-1h">--</div>
                            <div class="brain-stat-label">1-Hour Accuracy</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="backtest-result-eod">--</div>
                            <div class="brain-stat-label">End-of-Day Accuracy</div>
                        </div>
                        <div class="brain-stat">
                            <div class="brain-stat-value" id="backtest-result-nextday">--</div>
                            <div class="brain-stat-label">Next-Day Accuracy</div>
                        </div>
                    </div>

                    <!-- Top Features -->
                    <div style="margin-top: 30px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">üéØ Top Performing Features</h4>
                        <div id="backtest-top-features" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backtest History -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìú Backtest History</span>
                </div>
                <div style="padding: 20px;">
                    <div id="backtest-history">
                        <p style="color: var(--text-muted); text-align: center;">Run a backtest to see results here.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content" id="tab-settings">
            <!-- Trading Mode -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üéÆ Trading Mode</span>
                </div>
                <div style="padding: 20px;">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 10px; padding: 15px 25px; background: var(--bg-primary); border-radius: 8px; cursor: pointer; border: 2px solid var(--border-color);" class="mode-option" data-mode="paper">
                            <input type="radio" name="trading-mode" value="paper" checked style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">üìù Paper Trading</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Simulated trades, no real money</div>
                            </div>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; padding: 15px 25px; background: var(--bg-primary); border-radius: 8px; cursor: pointer; border: 2px solid var(--border-color);" class="mode-option" data-mode="live">
                            <input type="radio" name="trading-mode" value="live" style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 600; color: var(--dusty-rose);">üí∞ Live Trading</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Real money - use with caution!</div>
                            </div>
                        </label>
                    </div>
                    <p style="color: var(--text-muted); font-size: 12px; margin-top: 15px;">
                        ‚ö†Ô∏è Switching to live mode requires confirmation and will use real funds from your Alpaca account.
                    </p>
                </div>
            </div>

            <!-- Risk Management Settings -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üõ°Ô∏è Risk Management</span>
                </div>
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px;">
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Max Position Size (% of portfolio)
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="setting-max-position" min="1" max="25" value="10"
                                       style="flex: 1;" oninput="updateRangeValue(this, 'max-position-value', '%')">
                                <span id="max-position-value" style="color: var(--text-primary); font-weight: 600; min-width: 50px;">10%</span>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Max Daily Loss (% - stops trading)
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="setting-max-daily-loss" min="1" max="10" value="5"
                                       style="flex: 1;" oninput="updateRangeValue(this, 'max-daily-loss-value', '%')">
                                <span id="max-daily-loss-value" style="color: var(--text-primary); font-weight: 600; min-width: 50px;">5%</span>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Default Stop Loss (%)
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="setting-stop-loss" min="0.5" max="5" step="0.5" value="2"
                                       style="flex: 1;" oninput="updateRangeValue(this, 'stop-loss-value', '%')">
                                <span id="stop-loss-value" style="color: var(--text-primary); font-weight: 600; min-width: 50px;">2%</span>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Max Drawdown Limit (%)
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="setting-max-drawdown" min="5" max="30" value="15"
                                       style="flex: 1;" oninput="updateRangeValue(this, 'max-drawdown-value', '%')">
                                <span id="max-drawdown-value" style="color: var(--text-primary); font-weight: 600; min-width: 50px;">15%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Parameters -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üìä Trading Parameters</span>
                </div>
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px;">
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Initial Capital ($)
                            </label>
                            <input type="number" id="setting-initial-capital" value="100000" min="1000" step="1000"
                                   style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Default Order Type
                            </label>
                            <select id="setting-order-type"
                                    style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                                <option value="market">Market Order</option>
                                <option value="limit" selected>Limit Order</option>
                                <option value="stop_loss">Stop Loss</option>
                                <option value="stop_limit">Stop Limit</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Max Positions (Day Trading)
                            </label>
                            <input type="number" id="setting-max-positions" value="20" min="1" max="100"
                                   style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Max Trades Per Day
                            </label>
                            <input type="number" id="setting-max-trades" value="1000" min="1" max="5000"
                                   style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ML & AI Settings -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">ü§ñ AI & Machine Learning</span>
                </div>
                <div style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px;">
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Prediction Model
                            </label>
                            <select id="setting-ml-model"
                                    style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                                <option value="ensemble" selected>Ensemble (Recommended)</option>
                                <option value="xgboost">XGBoost</option>
                                <option value="lstm">LSTM Neural Network</option>
                                <option value="random_forest">Random Forest</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Min Confidence to Trade (%)
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="setting-min-confidence" min="50" max="90" value="65"
                                       style="flex: 1;" oninput="updateRangeValue(this, 'min-confidence-value', '%')">
                                <span id="min-confidence-value" style="color: var(--text-primary); font-weight: 600; min-width: 50px;">65%</span>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Sentiment Weight (0-1)
                            </label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="setting-sentiment-weight" min="0" max="100" value="30"
                                       style="flex: 1;" oninput="updateRangeValue(this, 'sentiment-weight-value', '%', 100)">
                                <span id="sentiment-weight-value" style="color: var(--text-primary); font-weight: 600; min-width: 50px;">0.30</span>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                                Model Retrain Frequency
                            </label>
                            <select id="setting-retrain-freq"
                                    style="width: 100%; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                                <option value="daily">Daily</option>
                                <option value="weekly" selected>Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Portfolio - Stocks You Own (Read-Only) -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üíº Portfolio (Stocks You Own)</span>
                </div>
                <div style="padding: 20px;">
                    <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 15px;">
                        These are stocks you currently own. The bot actively monitors them for sell signals.
                        This list updates automatically based on your trades.
                    </p>
                    <div id="portfolio-tags" style="display: flex; flex-wrap: wrap; gap: 10px; min-height: 40px;">
                        <span style="color: var(--text-muted); font-style: italic;">No positions yet - start trading to see stocks here</span>
                    </div>
                </div>
            </div>

            <!-- Watchlist Management - Stocks You're Watching -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">üëÄ Watchlist (Stocks You're Watching)</span>
                </div>
                <div style="padding: 20px;">
                    <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 15px;">
                        These are stocks the bot monitors for BUY opportunities. When it finds a good entry,
                        it will buy and move the stock to your Portfolio.
                    </p>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; color: var(--text-secondary); margin-bottom: 8px; font-size: 14px;">
                            Add symbols (comma-separated)
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="setting-watchlist" placeholder="AAPL, MSFT, GOOGL, TSLA"
                                   style="flex: 1; padding: 12px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 16px;">
                            <button onclick="addToWatchlist()" style="padding: 12px 20px; background: var(--sage-green); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Add
                            </button>
                        </div>
                    </div>
                    <div id="watchlist-tags" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <span class="watchlist-tag" style="padding: 8px 15px; background: var(--bg-primary); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                            SPY <button onclick="removeFromWatchlist(this)" style="background: none; border: none; color: var(--text-muted); cursor: pointer;">√ó</button>
                        </span>
                        <span class="watchlist-tag" style="padding: 8px 15px; background: var(--bg-primary); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                            QQQ <button onclick="removeFromWatchlist(this)" style="background: none; border: none; color: var(--text-muted); cursor: pointer;">√ó</button>
                        </span>
                        <span class="watchlist-tag" style="padding: 8px 15px; background: var(--bg-primary); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                            IWM <button onclick="removeFromWatchlist(this)" style="background: none; border: none; color: var(--text-muted); cursor: pointer;">√ó</button>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px;">
                <button onclick="resetSettings()" style="padding: 14px 28px; background: var(--card-bg); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; cursor: pointer;">
                    Reset to Defaults
                </button>
                <button onclick="saveSettings()" style="padding: 14px 28px; background: var(--sage-green); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                    üíæ Save Settings
                </button>
            </div>

            <!-- Settings Info -->
            <div class="card" style="margin-top: 20px; border-left: 3px solid var(--warm-gold);">
                <div style="padding: 20px;">
                    <p style="color: var(--text-secondary); margin: 0 0 10px 0;">
                        <strong style="color: var(--warm-gold);">‚ÑπÔ∏è How Stock Lists Work:</strong>
                    </p>
                    <ul style="color: var(--text-secondary); margin: 0; padding-left: 20px; line-height: 1.8;">
                        <li><strong style="color: var(--sage-green);">Portfolio</strong> = Stocks you OWN. Bot monitors these for SELL signals (exits).</li>
                        <li><strong style="color: var(--text-primary);">Watchlist</strong> = Stocks you're WATCHING. Bot monitors these for BUY signals (entries).</li>
                        <li>When bot buys a stock, it moves from Watchlist to Portfolio automatically.</li>
                        <li>When bot sells a stock, it moves from Portfolio back to Watchlist.</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ============================================
        // THE ALCHEMY EFFECT - JavaScript
        // ============================================

        const API_BASE = '';

        // Tab Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                switchTab(tabId);
            });
        });

        function switchTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`.nav-tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // Load tab-specific data
            if (tabId === 'brain') loadBrainDetails();
            if (tabId === 'trades') loadTrades();
            if (tabId === 'reports') loadReports();
        }

        // API Calls
        async function api(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                return await response.json();
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                return null;
            }
        }

        async function controlBot(action) {
            try {
                // Show immediate feedback in the UI
                const statusEl = document.getElementById('bot-status');
                const textEl = document.getElementById('bot-status-text');

                if (action === 'start') {
                    statusEl.className = 'bot-status active';
                    textEl.textContent = 'Starting...';
                } else if (action === 'stop') {
                    statusEl.className = 'bot-status inactive';
                    textEl.textContent = 'Stopping...';
                }

                const response = await fetch(`${API_BASE}/api/bot/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                const data = await response.json();

                // Immediately refresh activity feed and status
                loadActivityFeed();
                loadStatus();

                // Keep refreshing activity feed rapidly for a few seconds during startup
                if (action === 'start' && data.success) {
                    let refreshCount = 0;
                    const rapidRefresh = setInterval(() => {
                        loadActivityFeed();
                        loadStatus();
                        refreshCount++;
                        if (refreshCount >= 10) {
                            clearInterval(rapidRefresh);
                        }
                    }, 1000);
                }
            } catch (error) {
                console.error('Control error:', error);
            }
        }

        // Load Dashboard Data
        async function loadDashboard() {
            await Promise.all([
                loadStatus(),
                loadBrain(),
                loadPnL(),
                loadTrending(),
                loadYesterday(),
                loadPredicted(),
                loadActivityFeed()
            ]);
        }

        // Activity Feed
        async function loadActivityFeed() {
            const data = await api('/api/activity');
            const container = document.getElementById('activity-feed-content');

            if (!data || !data.activities || data.activities.length === 0) {
                container.innerHTML = `
                    <div class="activity-empty">
                        <div class="activity-empty-icon">üì°</div>
                        <div>Waiting for bot activity...</div>
                        <div style="margin-top: 4px; font-size: 11px;">${data?.bot_active ? 'Bot is running, watching for signals...' : 'Start the bot to see live updates'}</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.activities.map(activity => {
                const message = formatActivityMessage(activity);
                const time = formatActivityTime(activity.timestamp);
                const badge = getActivityBadge(activity);

                return `
                    <div class="activity-item">
                        <div class="activity-icon ${activity.icon}">${getActivityIcon(activity.icon)}</div>
                        <div class="activity-content">
                            <div class="activity-message">${message}</div>
                            <div class="activity-meta">
                                <span class="activity-time">${time}</span>
                                ${badge}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getActivityIcon(type) {
            const icons = {
                'prediction': 'üîÆ',
                'confirmed': '‚úì',
                'alert': '‚ö†',
                'trade': 'üí∞',
                'analysis': 'üìä',
                'learning': 'üß†',
                'cycle': 'üîÑ',
                'strategy': 'üß†',
                'signal': '‚ö°',
                'backtest': 'üìà',
                'data': 'üì•',
                'status': 'üöÄ',
                'watchlist': 'üìã',
                'screening': 'üîé',
                'monitor': 'üëÅÔ∏è',
                'performance': 'üìä',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è',
                'search': 'üîç',
                'brain': 'üß†',
                'chart': 'üìà',
                'list': 'üìã',
                'filter': 'üîé',
                'active': 'üü¢',
                'inactive': '‚èπÔ∏è',
                'loading': '‚è≥'
            };
            return icons[type] || 'üìå';
        }

        function formatActivityMessage(activity) {
            // New format: activity.message contains the pre-formatted message from log parsing
            if (activity.message) {
                // Highlight stock symbols in the message
                let msg = activity.message;
                if (activity.symbol) {
                    msg = msg.replace(new RegExp(`\\b${activity.symbol}\\b`, 'g'), `<span class="symbol">${activity.symbol}</span>`);
                }
                // Highlight prices
                msg = msg.replace(/\$(\d+\.?\d*)/g, '<span class="price">$$$1</span>');
                // Highlight percentages
                msg = msg.replace(/(\d+\.?\d*)%/g, '<span class="highlight">$1%</span>');
                return msg;
            }

            // Fallback for legacy format (data-based activities)
            const d = activity.data || {};
            const symbol = activity.symbol ? `<span class="symbol">${activity.symbol}</span>` : '';

            switch(activity.message_type) {
                case 'new_prediction':
                    const direction = d.direction === 'up' ? 'üìà rise' : 'üìâ fall';
                    const target = d.target_price ? `<span class="price">$${d.target_price.toFixed(2)}</span>` : '';
                    const change = d.expected_change_pct ? ` (${d.expected_change_pct > 0 ? '+' : ''}${d.expected_change_pct.toFixed(1)}%)` : '';
                    return `Predicting ${symbol} to ${direction} to ${target}${change} with <span class="confidence">${d.confidence?.toFixed(0)}% confidence</span>`;

                case 'prediction_confirmed':
                    const result = d.is_correct;
                    const actualDir = d.actual_direction === 'up' ? 'rose' : 'fell';
                    const actualChange = d.actual_change_pct ? ` (${d.actual_change_pct > 0 ? '+' : ''}${d.actual_change_pct.toFixed(2)}%)` : '';
                    if (result) {
                        return `Prediction for ${symbol} <span class="profit">CONFIRMED</span>! Stock ${actualDir}${actualChange} as predicted`;
                    } else {
                        return `Prediction for ${symbol} was <span class="loss">incorrect</span>. Stock ${actualDir}${actualChange} (predicted ${d.predicted_direction})`;
                    }

                case 'trade_executed':
                    const action = d.action?.toUpperCase() || 'TRADE';
                    const qty = d.quantity?.toFixed(0) || 0;
                    const price = d.price ? `<span class="price">$${d.price.toFixed(2)}</span>` : '';

                    if (d.pnl !== null && d.pnl !== undefined) {
                        const pnlClass = d.pnl >= 0 ? 'profit' : 'loss';
                        const pnlSign = d.pnl >= 0 ? '+' : '';
                        return `<span class="highlight">${action}</span> ${qty} shares of ${symbol} @ ${price}. P&L: <span class="${pnlClass}">${pnlSign}$${Math.abs(d.pnl).toFixed(2)}</span>`;
                    }
                    return `<span class="highlight">${action}</span> ${qty} shares of ${symbol} @ ${price}`;

                default:
                    return d.message || 'Activity logged';
            }
        }

        function formatActivityTime(timestamp) {
            if (!timestamp) return 'just now';

            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function getActivityBadge(activity) {
            if (activity.message_type === 'prediction_confirmed') {
                if (activity.data.is_correct) {
                    return '<span class="activity-badge correct">Correct</span>';
                } else {
                    return '<span class="activity-badge wrong">Wrong</span>';
                }
            }
            if (activity.message_type === 'new_prediction') {
                return '<span class="activity-badge pending">Pending</span>';
            }
            return '';
        }

        async function loadStatus() {
            const data = await api('/api/status');
            if (data) {
                const statusEl = document.getElementById('bot-status');
                const textEl = document.getElementById('bot-status-text');

                if (data.bot_active) {
                    statusEl.className = 'bot-status active';
                    textEl.textContent = 'Bot Active';
                } else {
                    statusEl.className = 'bot-status inactive';
                    textEl.textContent = 'Bot Inactive';
                }
            }
        }

        async function loadBrain() {
            const data = await api('/api/brain');
            if (data) {
                document.getElementById('brain-accuracy').textContent = `${data.overall_accuracy?.toFixed(1) || 0}%`;
                document.getElementById('brain-predictions').textContent = data.total_predictions || 0;
                document.getElementById('brain-correct').textContent = data.correct || 0;

                // Latest activity
                if (data.global_weights && data.global_weights.length > 0) {
                    const top = data.global_weights[0];
                    document.getElementById('brain-latest').textContent =
                        `Top signal: ${top.name} (${top.weight.toFixed(2)} weight, ${top.accuracy.toFixed(0)}% accuracy)`;
                }
            }
        }

        async function loadPnL() {
            const data = await api('/api/pnl');
            if (data) {
                const pnlValue = document.getElementById('pnl-value');
                const pnlPercent = document.getElementById('pnl-percent');

                const todayPnl = data.today_pnl || 0;
                const todayPct = data.today_pnl_pct || 0;

                pnlValue.textContent = `${todayPnl >= 0 ? '+' : ''}$${Math.abs(todayPnl).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                pnlValue.className = `pnl-value ${todayPnl >= 0 ? 'positive' : 'negative'}`;

                pnlPercent.innerHTML = `<span>${todayPnl >= 0 ? '‚ñ≤' : '‚ñº'}</span><span>${Math.abs(todayPct).toFixed(2)}% today</span>`;
                pnlPercent.className = `pnl-percent ${todayPnl >= 0 ? 'positive' : 'negative'}`;

                // Journey
                document.getElementById('initial-capital').textContent = `$${(data.initial_capital || 100000).toLocaleString()}`;
                document.getElementById('current-value').textContent = `$${(data.current_value || 100000).toLocaleString()}`;

                // Sparkline
                renderSparkline(data.sparkline || []);
            }
        }

        function renderSparkline(data) {
            const container = document.getElementById('sparkline');
            if (!data.length) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">No data yet</div>';
                return;
            }

            const maxVal = Math.max(...data.map(d => Math.abs(d.cumulative || 0)), 1);

            container.innerHTML = data.map(d => {
                const height = Math.max(10, (Math.abs(d.cumulative || 0) / maxVal) * 100);
                return `<div class="sparkline-bar" style="height: ${height}%" title="${d.date}: $${d.cumulative?.toFixed(2)}"></div>`;
            }).join('');
        }

        async function loadTrending() {
            const data = await api('/api/trending');
            const container = document.getElementById('trending-list');

            if (!data || !data.trending || data.trending.length === 0) {
                container.innerHTML = '<div class="empty-state">No trending stocks</div>';
                return;
            }

            container.innerHTML = data.trending.map(t => `
                <div class="trending-item">
                    <span class="trending-symbol">${t.symbol}</span>
                    <div class="trending-meta">
                        <span class="trending-change up">‚ñ≤</span>
                        <span class="trending-confidence">üß† ${t.confidence?.toFixed(0) || 0}%</span>
                    </div>
                </div>
            `).join('');
        }

        async function loadYesterday() {
            const data = await api('/api/yesterday');
            if (data) {
                const pnl = data.pnl || 0;
                document.getElementById('yesterday-pnl').textContent = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`;
                document.getElementById('yesterday-pnl').className = `yesterday-value ${pnl >= 0 ? 'positive' : 'negative'}`;

                document.getElementById('yesterday-trades').textContent = `${data.trades || 0} (${data.wins || 0}W/${data.losses || 0}L)`;
                document.getElementById('yesterday-winrate').textContent = `${(data.win_rate || 0).toFixed(0)}%`;

                if (data.best_trade) {
                    document.getElementById('yesterday-best').textContent = `${data.best_trade.symbol} +$${data.best_trade.pnl?.toFixed(2)}`;
                } else {
                    document.getElementById('yesterday-best').textContent = '--';
                }
            }
        }

        async function loadPredicted() {
            const data = await api('/api/predicted-profit');
            if (data) {
                document.getElementById('predicted-range').textContent =
                    `$${data.predicted_low?.toFixed(0) || 0} ‚Äì $${data.predicted_high?.toFixed(0) || 0}`;
                document.getElementById('predicted-signals').textContent = data.open_signals || 0;
                document.getElementById('predicted-conf-text').textContent = `${data.avg_confidence?.toFixed(0) || 0}%`;
                document.getElementById('predicted-conf-bar').style.width = `${data.avg_confidence || 0}%`;
            }
        }

        async function loadBrainDetails() {
            const data = await api('/api/brain/details');
            if (!data) return;

            // Summary
            document.getElementById('brain-detail-accuracy').textContent = `${data.summary?.overall_accuracy?.toFixed(1) || 0}%`;
            document.getElementById('brain-detail-total').textContent = data.summary?.total_predictions || 0;
            document.getElementById('brain-detail-correct').textContent = data.summary?.correct || 0;
            document.getElementById('brain-detail-wrong').textContent = data.summary?.wrong || 0;

            // Global Weights
            const weightsContainer = document.getElementById('global-weights');
            if (data.global_weights && data.global_weights.length > 0) {
                weightsContainer.innerHTML = data.global_weights.map(w => `
                    <div class="weight-card">
                        <div class="weight-header">
                            <span class="weight-name">${w.name}</span>
                            <span class="weight-badge ${w.status}">${w.status.toUpperCase()}</span>
                        </div>
                        <div class="weight-description">${w.description}</div>
                        <div class="weight-bar-container">
                            <div class="weight-bar">
                                <div class="weight-bar-fill ${w.status}" style="width: ${(w.weight / 2) * 100}%"></div>
                            </div>
                        </div>
                        <div class="weight-stats">
                            <span>Weight: ${w.weight.toFixed(3)}</span>
                            <span>${w.accuracy.toFixed(0)}% acc (${w.uses} uses)</span>
                        </div>
                    </div>
                `).join('');
            } else {
                weightsContainer.innerHTML = '<div class="empty-state">No weight data yet</div>';
            }

            // Stock Profiles
            const stocksContainer = document.getElementById('stock-profiles');
            if (data.stock_profiles && data.stock_profiles.length > 0) {
                stocksContainer.innerHTML = data.stock_profiles.slice(0, 10).map(stock => `
                    <div class="stock-profile">
                        <div class="stock-header">
                            <span class="stock-symbol">${stock.symbol}</span>
                            <span class="stock-predictions">${stock.total_predictions} predictions</span>
                        </div>
                        <div class="stock-signals">
                            ${stock.signals.map(s => {
                                const indicator = s.weight > 1.1 ? 'up' : (s.weight < 0.9 ? 'down' : 'neutral');
                                const arrow = s.weight > 1.1 ? '‚ñ≤' : (s.weight < 0.9 ? '‚ñº' : '‚óè');
                                return `<div class="stock-signal">
                                    <span class="signal-indicator ${indicator}">${arrow}</span>
                                    <span>${s.name}</span>
                                    <span style="color: var(--text-muted)">${s.weight.toFixed(2)}</span>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                `).join('');
            } else {
                stocksContainer.innerHTML = '<div class="empty-state">No per-stock learning data yet. The bot needs more predictions to learn stock-specific patterns.</div>';
            }
        }

        async function loadTrades() {
            const data = await api('/api/trades');
            const tbody = document.getElementById('trades-body');

            if (!data || !data.trades || data.trades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div style="padding: 20px;">
                                <strong>No paper/live trades yet</strong><br>
                                <span style="font-size: 12px; color: var(--text-muted);">
                                    The bot needs to execute trades in paper or live mode.<br>
                                    Backtest trades are not shown here.
                                </span>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.trades.map(t => {
                const pnlClass = t.pnl > 0 ? 'positive' : (t.pnl < 0 ? 'negative' : '');
                const pnlText = t.pnl ? `${t.pnl >= 0 ? '+' : ''}$${t.pnl.toFixed(2)}` : '--';
                const modeLabel = t.mode === 'live' ? 'üî¥ LIVE' : (t.mode === 'paper' ? 'üìù Paper' : t.mode);

                return `
                    <tr>
                        <td>${new Date(t.timestamp).toLocaleString()}</td>
                        <td class="trade-symbol">${t.symbol}</td>
                        <td><span class="trade-action ${t.action}">${t.action.toUpperCase()}</span></td>
                        <td>${t.quantity.toFixed(2)}</td>
                        <td>$${t.price.toFixed(2)}</td>
                        <td class="trade-pnl ${pnlClass}">${pnlText}</td>
                        <td>${t.strategy || '--'} <span style="font-size: 10px; color: var(--text-muted);">(${modeLabel})</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // REPORTS FUNCTIONS
        // ============================================

        async function loadReports() {
            const days = parseInt(document.getElementById('report-period').value);
            const data = await api(`/api/reports?days=${days}`);

            if (!data) {
                // Show empty state if no data
                showEmptyReports();
                return;
            }

            // Update summary stats
            const totalPnl = data.total_pnl || 0;
            document.getElementById('report-total-pnl').textContent = `${totalPnl >= 0 ? '+' : ''}$${Math.abs(totalPnl).toFixed(2)}`;
            document.getElementById('report-total-pnl').style.color = totalPnl >= 0 ? 'var(--sage-green)' : 'var(--dusty-rose)';

            document.getElementById('report-total-trades').textContent = data.total_trades || 0;
            document.getElementById('report-win-rate').textContent = `${(data.win_rate || 0).toFixed(1)}%`;
            document.getElementById('report-win-rate').style.color = (data.win_rate || 0) >= 50 ? 'var(--sage-green)' : 'var(--dusty-rose)';

            document.getElementById('report-profit-factor').textContent = (data.profit_factor || 0).toFixed(2);
            document.getElementById('report-avg-win').textContent = `+$${(data.avg_win || 0).toFixed(2)}`;
            document.getElementById('report-avg-win').style.color = 'var(--sage-green)';
            document.getElementById('report-avg-loss').textContent = `-$${Math.abs(data.avg_loss || 0).toFixed(2)}`;
            document.getElementById('report-avg-loss').style.color = 'var(--dusty-rose)';
            document.getElementById('report-max-drawdown').textContent = `${(data.max_drawdown || 0).toFixed(1)}%`;
            document.getElementById('report-sharpe').textContent = (data.sharpe_ratio || 0).toFixed(2);

            // Render daily P&L chart
            renderDailyPnlChart(data.daily_pnl || []);

            // Render top performers
            renderPerformers('top-performers', data.top_performers || [], true);
            renderPerformers('worst-performers', data.worst_performers || [], false);

            // Render strategy performance
            renderStrategyPerformance(data.strategy_performance || []);

            // Render trade log
            renderReportTrades(data.trades || []);
        }

        function showEmptyReports() {
            document.getElementById('report-total-pnl').textContent = '$0.00';
            document.getElementById('report-total-trades').textContent = '0';
            document.getElementById('report-win-rate').textContent = '0%';
            document.getElementById('report-profit-factor').textContent = '0.00';
            document.getElementById('report-avg-win').textContent = '$0.00';
            document.getElementById('report-avg-loss').textContent = '$0.00';
            document.getElementById('report-max-drawdown').textContent = '0%';
            document.getElementById('report-sharpe').textContent = '0.00';
            document.getElementById('daily-pnl-chart').innerHTML = '<div class="empty-state">No data for selected period</div>';
            document.getElementById('top-performers').innerHTML = '<div class="empty-state">No data</div>';
            document.getElementById('worst-performers').innerHTML = '<div class="empty-state">No data</div>';
            document.getElementById('strategy-performance-body').innerHTML = '<tr><td colspan="5" class="empty-state">No data</td></tr>';
            document.getElementById('report-trades-body').innerHTML = '<tr><td colspan="8" class="empty-state">No trades in selected period</td></tr>';
        }

        function renderDailyPnlChart(dailyPnl) {
            const container = document.getElementById('daily-pnl-chart');

            if (!dailyPnl || dailyPnl.length === 0) {
                container.innerHTML = '<div class="empty-state">No daily P&L data</div>';
                return;
            }

            const maxVal = Math.max(...dailyPnl.map(d => Math.abs(d.pnl)), 1);

            container.innerHTML = dailyPnl.map(d => {
                const height = Math.max(5, (Math.abs(d.pnl) / maxVal) * 100);
                const color = d.pnl >= 0 ? 'var(--sage-green)' : 'var(--dusty-rose)';
                return `<div style="flex: 1; background: ${color}; height: ${height}%; border-radius: 2px 2px 0 0; min-height: 4px;"
                            title="${d.date}: ${d.pnl >= 0 ? '+' : ''}$${d.pnl.toFixed(2)}"></div>`;
            }).join('');
        }

        function renderPerformers(containerId, performers, isTop) {
            const container = document.getElementById(containerId);

            if (!performers || performers.length === 0) {
                container.innerHTML = '<div class="empty-state">No data</div>';
                return;
            }

            container.innerHTML = performers.slice(0, 5).map((p, i) => `
                <div class="trending-item">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: var(--text-muted); font-size: 12px;">#${i + 1}</span>
                        <span class="trending-symbol">${p.symbol}</span>
                    </div>
                    <div class="trending-meta">
                        <span style="color: ${isTop ? 'var(--sage-green)' : 'var(--dusty-rose)'}; font-family: 'JetBrains Mono', monospace;">
                            ${p.pnl >= 0 ? '+' : ''}$${p.pnl.toFixed(2)}
                        </span>
                        <span class="trending-confidence">${p.trades} trades</span>
                    </div>
                </div>
            `).join('');
        }

        function renderStrategyPerformance(strategies) {
            const tbody = document.getElementById('strategy-performance-body');

            if (!strategies || strategies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No strategy data</td></tr>';
                return;
            }

            tbody.innerHTML = strategies.map(s => {
                const pnlClass = s.pnl >= 0 ? 'positive' : 'negative';
                return `
                    <tr>
                        <td style="font-weight: 600;">${s.name}</td>
                        <td>${s.trades}</td>
                        <td style="color: ${s.win_rate >= 50 ? 'var(--sage-green)' : 'var(--dusty-rose)'};">${s.win_rate.toFixed(1)}%</td>
                        <td class="trade-pnl ${pnlClass}">${s.pnl >= 0 ? '+' : ''}$${s.pnl.toFixed(2)}</td>
                        <td>$${s.avg_trade.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderReportTrades(trades) {
            const tbody = document.getElementById('report-trades-body');

            if (!trades || trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No trades in selected period</td></tr>';
                return;
            }

            tbody.innerHTML = trades.slice(0, 20).map(t => {
                const pnlClass = (t.pnl || 0) >= 0 ? 'positive' : 'negative';
                return `
                    <tr>
                        <td>${new Date(t.timestamp).toLocaleDateString()}</td>
                        <td class="trade-symbol">${t.symbol}</td>
                        <td><span class="trade-action ${t.action}">${t.action.toUpperCase()}</span></td>
                        <td>${(t.quantity || 0).toFixed(2)}</td>
                        <td>$${(t.entry_price || t.price || 0).toFixed(2)}</td>
                        <td>$${(t.exit_price || 0).toFixed(2)}</td>
                        <td class="trade-pnl ${pnlClass}">${t.pnl ? (t.pnl >= 0 ? '+' : '') + '$' + t.pnl.toFixed(2) : '--'}</td>
                        <td>${t.strategy || '--'}</td>
                    </tr>
                `;
            }).join('');
        }

        function exportReport(format) {
            const days = document.getElementById('report-period').value;
            if (format === 'csv') {
                window.open(`${API_BASE}/api/reports/export?days=${days}&format=csv`, '_blank');
            } else if (format === 'pdf') {
                alert('PDF export coming soon! For now, use CSV export.');
            }
        }

        // ============================================
        // BACKTEST FUNCTIONS
        // ============================================

        let backtestHistory = [];

        async function runBacktest() {
            const symbol = document.getElementById('backtest-symbol').value.trim().toUpperCase();
            const startDate = document.getElementById('backtest-start').value;
            const endDate = document.getElementById('backtest-end').value;
            const strategy = document.getElementById('backtest-strategy').value;
            const mode = document.getElementById('backtest-mode').value;

            // Validation
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }
            if (!startDate || !endDate) {
                alert('Please select start and end dates');
                return;
            }
            if (new Date(startDate) >= new Date(endDate)) {
                alert('Start date must be before end date');
                return;
            }

            // Show progress
            const btn = document.getElementById('backtest-run-btn');
            const progressCard = document.getElementById('backtest-progress-card');
            const resultsCard = document.getElementById('backtest-results-card');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px;"></span> Running...';
            progressCard.style.display = 'block';
            resultsCard.style.display = 'none';

            // Simulate progress
            let progress = 0;
            const progressBar = document.getElementById('backtest-progress-bar');
            const progressText = document.getElementById('backtest-progress-text');

            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 15;
                    progressBar.style.width = Math.min(progress, 90) + '%';
                    progressText.textContent = `Processing ${symbol} historical data... ${Math.round(progress)}%`;
                }
            }, 500);

            try {
                const response = await fetch(`${API_BASE}/api/backtest/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        strategy: strategy,
                        start_date: startDate,
                        end_date: endDate,
                        initial_capital: 100000,
                        mode: mode
                    })
                });

                const data = await response.json();

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressText.textContent = 'Complete!';

                setTimeout(() => {
                    progressCard.style.display = 'none';

                    if (data.success) {
                        // Show results
                        resultsCard.style.display = 'block';
                        document.getElementById('backtest-result-symbol').textContent = data.symbol;
                        document.getElementById('backtest-result-predictions').textContent = data.results.totalPredictions.toLocaleString();
                        document.getElementById('backtest-result-accuracy').textContent = (data.results.accuracy * 100).toFixed(1) + '%';
                        document.getElementById('backtest-result-1h').textContent = (data.results.accuracy1h * 100).toFixed(1) + '%';
                        document.getElementById('backtest-result-eod').textContent = (data.results.accuracyEod * 100).toFixed(1) + '%';
                        document.getElementById('backtest-result-nextday').textContent = (data.results.accuracyNextDay * 100).toFixed(1) + '%';

                        // Top features
                        const featuresContainer = document.getElementById('backtest-top-features');
                        if (data.results.topFeatures && data.results.topFeatures.length > 0) {
                            featuresContainer.innerHTML = data.results.topFeatures.map(([name, weight]) => `
                                <div style="background: var(--bg-primary); padding: 15px; border-radius: 8px; border-left: 3px solid var(--sage-green);">
                                    <div style="font-weight: 600; color: var(--text-primary);">${name}</div>
                                    <div style="color: var(--sage-green); font-size: 18px; font-weight: bold;">${weight.toFixed(3)}</div>
                                </div>
                            `).join('');
                        }

                        // Add to history
                        backtestHistory.unshift({
                            symbol: data.symbol,
                            startDate: startDate,
                            endDate: endDate,
                            strategy: strategy,
                            accuracy: data.results.accuracy,
                            predictions: data.results.totalPredictions,
                            timestamp: new Date().toISOString()
                        });

                        updateBacktestHistory();
                    } else {
                        alert('Backtest failed: ' + (data.error || 'Unknown error'));
                    }
                }, 500);

            } catch (error) {
                clearInterval(progressInterval);
                progressCard.style.display = 'none';
                alert('Error running backtest: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>‚ñ∂</span> Run Backtest';
            }
        }

        function updateBacktestHistory() {
            const container = document.getElementById('backtest-history');

            if (backtestHistory.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">Run a backtest to see results here.</p>';
                return;
            }

            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="text-align: left; padding: 12px; color: var(--text-secondary);">Symbol</th>
                            <th style="text-align: left; padding: 12px; color: var(--text-secondary);">Period</th>
                            <th style="text-align: left; padding: 12px; color: var(--text-secondary);">Strategy</th>
                            <th style="text-align: right; padding: 12px; color: var(--text-secondary);">Predictions</th>
                            <th style="text-align: right; padding: 12px; color: var(--text-secondary);">Accuracy</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${backtestHistory.slice(0, 10).map(bt => `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 12px; font-weight: 600; color: var(--text-primary);">${bt.symbol}</td>
                                <td style="padding: 12px; color: var(--text-secondary);">${bt.startDate} to ${bt.endDate}</td>
                                <td style="padding: 12px; color: var(--text-secondary);">${bt.strategy}</td>
                                <td style="padding: 12px; text-align: right; color: var(--text-primary);">${bt.predictions.toLocaleString()}</td>
                                <td style="padding: 12px; text-align: right; color: ${bt.accuracy >= 0.55 ? 'var(--sage-green)' : 'var(--dusty-rose)'}; font-weight: 600;">
                                    ${(bt.accuracy * 100).toFixed(1)}%
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Initialize backtest dates to reasonable defaults
        function initBacktestDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setFullYear(startDate.getFullYear() - 2); // 2 years ago

            document.getElementById('backtest-end').value = endDate.toISOString().split('T')[0];
            document.getElementById('backtest-start').value = startDate.toISOString().split('T')[0];
        }

        // ============================================
        // SETTINGS FUNCTIONS
        // ============================================

        const DEFAULT_SETTINGS = {
            tradingMode: 'paper',
            maxPosition: 10,
            maxDailyLoss: 5,
            stopLoss: 2,
            maxDrawdown: 15,
            initialCapital: 100000,
            orderType: 'limit',
            maxPositions: 20,
            maxTrades: 1000,
            mlModel: 'ensemble',
            minConfidence: 65,
            sentimentWeight: 30,
            retrainFreq: 'weekly',
            watchlist: ['SPY', 'QQQ', 'IWM']
        };

        function updateRangeValue(input, displayId, suffix = '', divisor = 1) {
            const value = parseFloat(input.value);
            const display = document.getElementById(displayId);
            if (divisor > 1) {
                display.textContent = (value / divisor).toFixed(2);
            } else {
                display.textContent = value + suffix;
            }
        }

        async function loadSettings() {
            const saved = localStorage.getItem('alchemySettings');
            const settings = saved ? JSON.parse(saved) : DEFAULT_SETTINGS;

            // Try to get portfolio AND watchlist from server (most up-to-date)
            try {
                const response = await fetch(`${API_BASE}/api/watchlist`);
                const data = await response.json();

                // Render portfolio (read-only)
                if (data.portfolio && data.portfolio.length > 0) {
                    renderPortfolio(data.portfolio);
                } else {
                    renderPortfolio([]);
                }

                // Render watchlist (editable)
                if (data.watchlist && data.watchlist.length > 0) {
                    settings.watchlist = data.watchlist;
                }
            } catch (e) {
                console.log('Could not fetch watchlist from server, using local');
                renderPortfolio([]);
            }

            // Trading mode
            document.querySelector(`input[name="trading-mode"][value="${settings.tradingMode}"]`).checked = true;

            // Risk settings
            document.getElementById('setting-max-position').value = settings.maxPosition;
            updateRangeValue(document.getElementById('setting-max-position'), 'max-position-value', '%');

            document.getElementById('setting-max-daily-loss').value = settings.maxDailyLoss;
            updateRangeValue(document.getElementById('setting-max-daily-loss'), 'max-daily-loss-value', '%');

            document.getElementById('setting-stop-loss').value = settings.stopLoss;
            updateRangeValue(document.getElementById('setting-stop-loss'), 'stop-loss-value', '%');

            document.getElementById('setting-max-drawdown').value = settings.maxDrawdown;
            updateRangeValue(document.getElementById('setting-max-drawdown'), 'max-drawdown-value', '%');

            // Trading params
            document.getElementById('setting-initial-capital').value = settings.initialCapital;
            document.getElementById('setting-order-type').value = settings.orderType;
            document.getElementById('setting-max-positions').value = settings.maxPositions;
            document.getElementById('setting-max-trades').value = settings.maxTrades;

            // ML settings
            document.getElementById('setting-ml-model').value = settings.mlModel;
            document.getElementById('setting-min-confidence').value = settings.minConfidence;
            updateRangeValue(document.getElementById('setting-min-confidence'), 'min-confidence-value', '%');

            document.getElementById('setting-sentiment-weight').value = settings.sentimentWeight;
            updateRangeValue(document.getElementById('setting-sentiment-weight'), 'sentiment-weight-value', '%', 100);

            document.getElementById('setting-retrain-freq').value = settings.retrainFreq;

            // Watchlist
            renderWatchlist(settings.watchlist);
        }

        function renderPortfolio(symbols) {
            const container = document.getElementById('portfolio-tags');
            if (symbols.length === 0) {
                container.innerHTML = '<span style="color: var(--text-muted); font-style: italic;">No positions yet - start trading to see stocks here</span>';
            } else {
                container.innerHTML = symbols.map(symbol => `
                    <span class="portfolio-tag" style="padding: 8px 15px; background: var(--sage-green); color: white; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-weight: 500;">
                        ${symbol}
                    </span>
                `).join('');
            }
        }

        async function saveSettings() {
            const tradingMode = document.querySelector('input[name="trading-mode"]:checked').value;

            // Confirm if switching to live
            if (tradingMode === 'live') {
                if (!confirm('‚ö†Ô∏è WARNING: You are switching to LIVE trading mode!\n\nThis will use REAL MONEY from your Alpaca account.\n\nAre you absolutely sure?')) {
                    document.querySelector('input[name="trading-mode"][value="paper"]').checked = true;
                    return;
                }
            }

            const settings = {
                tradingMode: tradingMode,
                maxPosition: parseInt(document.getElementById('setting-max-position').value),
                maxDailyLoss: parseInt(document.getElementById('setting-max-daily-loss').value),
                stopLoss: parseFloat(document.getElementById('setting-stop-loss').value),
                maxDrawdown: parseInt(document.getElementById('setting-max-drawdown').value),
                initialCapital: parseInt(document.getElementById('setting-initial-capital').value),
                orderType: document.getElementById('setting-order-type').value,
                maxPositions: parseInt(document.getElementById('setting-max-positions').value),
                maxTrades: parseInt(document.getElementById('setting-max-trades').value),
                mlModel: document.getElementById('setting-ml-model').value,
                minConfidence: parseInt(document.getElementById('setting-min-confidence').value),
                sentimentWeight: parseInt(document.getElementById('setting-sentiment-weight').value),
                retrainFreq: document.getElementById('setting-retrain-freq').value,
                watchlist: getWatchlistSymbols()
            };

            localStorage.setItem('alchemySettings', JSON.stringify(settings));

            // Also update the server-side watchlist
            try {
                const response = await fetch(`${API_BASE}/api/watchlist`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbols: settings.watchlist })
                });
                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ Settings saved successfully!\n\nWatchlist updated to: ${settings.watchlist.join(', ')}\n\nChanges are applied immediately.`);
                } else {
                    alert(`‚ö†Ô∏è Settings saved locally, but server update failed:\n${result.error}\n\nChanges will apply on next bot start.`);
                }
            } catch (e) {
                console.error('Error updating server watchlist:', e);
                alert('‚úÖ Settings saved locally!\n\nNote: Could not update server (is the bot running?).\nChanges will be applied on next bot start.');
            }
        }

        function resetSettings() {
            if (confirm('Reset all settings to defaults?')) {
                localStorage.removeItem('alchemySettings');
                loadSettings();
                alert('Settings reset to defaults.');
            }
        }

        function getWatchlistSymbols() {
            const tags = document.querySelectorAll('#watchlist-tags .watchlist-tag');
            return Array.from(tags).map(tag => tag.textContent.trim().replace('√ó', '').trim());
        }

        function renderWatchlist(symbols) {
            const container = document.getElementById('watchlist-tags');
            container.innerHTML = symbols.map(symbol => `
                <span class="watchlist-tag" style="padding: 8px 15px; background: var(--bg-primary); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                    ${symbol} <button onclick="removeFromWatchlist(this)" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 16px;">√ó</button>
                </span>
            `).join('');
        }

        function addToWatchlist() {
            const input = document.getElementById('setting-watchlist');
            const symbols = input.value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);

            if (symbols.length === 0) return;

            const current = getWatchlistSymbols();
            const updated = [...new Set([...current, ...symbols])]; // Dedupe

            renderWatchlist(updated);
            input.value = '';
        }

        function removeFromWatchlist(button) {
            button.parentElement.remove();
        }

        // Smart Auto-Refresh
        function isMarketOpen() {
            const now = new Date();
            const day = now.getDay();
            const hour = now.getHours();
            const minute = now.getMinutes();

            // Monday-Friday, 9:30 AM - 4:00 PM ET (simplified)
            if (day === 0 || day === 6) return false;
            if (hour < 9 || hour > 16) return false;
            if (hour === 9 && minute < 30) return false;

            return true;
        }

        function startAutoRefresh() {
            // Refresh dashboard every 30s during market hours, 5min otherwise
            const interval = isMarketOpen() ? 30000 : 300000;

            setInterval(() => {
                loadDashboard();
            }, interval);

            // Activity feed refreshes more frequently (every 10s) for real-time feel
            setInterval(() => {
                loadActivityFeed();
            }, 10000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            startAutoRefresh();
            initBacktestDates();
            loadSettings();
        });
    </script>
</body>
</html>
